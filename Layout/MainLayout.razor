@using System.Security.Claims
@using HosxpUi.Layout.Providers
@using HosxpUi.Services
@inherits LayoutComponentBase
@inject StateContainer StateContainer
@using Microsoft.AspNetCore.Components.Authorization
@using Blazored.LocalStorage
@inject AuthenticationStateProvider CustomAuthProvider
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider _authStateProvider;
@inject ILocalStorageService _localStorageService;

<MudThemeProvider />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />
<MudLayout>
    <MudAppBar Color="Color.Primary">
        <AuthorizeView>
            <Authorized>
                <MudMenu Label="OPD" Variant="Variant.Filled" Color="Color.Primary" AnchorOrigin="Origin.CenterCenter" TransformOrigin="Origin.TopLeft" Dense>
                    <MudMenuItem>
                        <MudMenu ActivationEvent="MouseEvent.MouseOver" AnchorOrigin="Origin.TopRight" TransformOrigin="Origin.TopLeft" Dense>
                            <ActivatorContent>
                                <MudMenuItem Href="/opd">ค้นหาคนไข้</MudMenuItem>
                            </ActivatorContent>

                            <ChildContent>
                                @* <MudMenuItem Href="/ward" Target="_blank">รายชื่อ ward2 </MudMenuItem> *@
                            </ChildContent>
                        </MudMenu>
                    </MudMenuItem>

                    @* <MudMenuItem>
                        <MudMenu ActivationEvent="MouseEvent.MouseOver" AnchorOrigin="Origin.TopRight" TransformOrigin="Origin.TopLeft" Dense>
                            <ActivatorContent>
                                <MudMenuItem Href="/">Item 2</MudMenuItem>
                            </ActivatorContent>

                            <ChildContent>
                                <MudMenuItem Href="/ward" Target="_blank">รายชื่อ ward2 </MudMenuItem>
                            </ChildContent>
                        </MudMenu>
                    </MudMenuItem> *@
                </MudMenu>
                <MudMenu Label="IPD" Variant="Variant.Filled" Color="Color.Primary" AnchorOrigin="Origin.CenterCenter" TransformOrigin="Origin.TopLeft" Dense>
                    <MudMenuItem>
                        <MudMenu ActivationEvent="MouseEvent.MouseOver" AnchorOrigin="Origin.TopRight" TransformOrigin="Origin.TopLeft" Dense>
                            <ActivatorContent>
                                <MudMenuItem Href="/ward">รายชื่อ ward</MudMenuItem>
                            </ActivatorContent>

                            <ChildContent>
                                @* <MudMenuItem Href="/ward" Target="_blank">รายชื่อ ward2 </MudMenuItem> *@
                                @* <MudMenuItem Href="/" Disabled="true"> Disabled Item 1.2 with navigation </MudMenuItem> *@
                            </ChildContent>
                        </MudMenu>
                    </MudMenuItem>

                    @* <MudMenuItem>
                        <MudMenu ActivationEvent="MouseEvent.MouseOver" AnchorOrigin="Origin.TopRight" TransformOrigin="Origin.TopLeft" Dense>
                            <ActivatorContent>
                                <MudMenuItem Href="/">Item 2</MudMenuItem>
                            </ActivatorContent>

                            <ChildContent>
                                <MudMenuItem Href="/ward" Target="_blank">รายชื่อ ward2 </MudMenuItem>
                            </ChildContent>
                        </MudMenu>
                    </MudMenuItem> *@
                </MudMenu>
                <MudMenu Label="งานห้องบัตร" Variant="Variant.Filled" Color="Color.Primary" AnchorOrigin="Origin.CenterCenter" TransformOrigin="Origin.TopLeft" Dense>
                    <MudMenuItem>
                        <MudMenu ActivationEvent="MouseEvent.MouseOver" AnchorOrigin="Origin.TopRight" TransformOrigin="Origin.TopLeft" Dense>
                            <ActivatorContent>
                                <MudMenuItem Href="/absentvisit">ลบ visit ที่คนไข้</MudMenuItem>
                            </ActivatorContent>

                            <ChildContent>
                                @* <MudMenuItem Href="/ward" Target="_blank">รายชื่อ ward2 </MudMenuItem> *@
                                @* <MudMenuItem Href="/" Disabled="true"> Disabled Item 1.2 with navigation </MudMenuItem> *@
                            </ChildContent>
                        </MudMenu>
                    </MudMenuItem>

                    @* <MudMenuItem>
                        <MudMenu ActivationEvent="MouseEvent.MouseOver" AnchorOrigin="Origin.TopRight" TransformOrigin="Origin.TopLeft" Dense>
                            <ActivatorContent>
                                <MudMenuItem Href="/">Item 2</MudMenuItem>
                            </ActivatorContent>

                            <ChildContent>
                                <MudMenuItem Href="/ward" Target="_blank">รายชื่อ ward2 </MudMenuItem>
                            </ChildContent>
                        </MudMenu>
                    </MudMenuItem> *@
                </MudMenu>
                <MudSpacer/>
                <MudLink Color="Color.Inherit" Underline="Underline.None" class="mr-2" OnClick="LogoutAsync">Logout</MudLink>
            </Authorized>
            <NotAuthorized>
                <MudLink Color="Color.Inherit" Underline="Underline.None" Class="mr-2" Href="/">สำนักงานดิจิทัลทางการแพทย์</MudLink>
                <MudSpacer/>
                <MudLink Color="Color.Inherit" Underline="Underline.None" Class="mr-2" Href="/login">Login</MudLink>
            </NotAuthorized>
        </AuthorizeView>
    </MudAppBar>
    <MudMainContent>
        @Body
    </MudMainContent>
</MudLayout>
@code{
    private string LoginName { get; set; }
    private string Role { get; set; }


    protected override async Task OnInitializedAsync()
    {
        var authState = await _authStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        // Extract the LoginName and Role from the user's claims
        LoginName = user?.FindFirst(c => c.Type == "LoginName")?.Value;
        Role = user?.FindFirst(c => c.Type == ClaimTypes.Role)?.Value;

        // Set the value in the state container
        StateContainer.LoginName = LoginName;
        StateContainer.Role = Role;
    }
     private async Task LogoutAsync()
    {
        // Clear the JWT token from local storage
        await _localStorageService.RemoveItemAsync("jwt-access-token");

        // Notify the authentication state provider to update the auth state
        if (_authStateProvider is CustomAuthProvider customAuthProvider)
        {
            customAuthProvider.NotifyAuthState();
        }

        // Redirect the user to the login page or home page
        NavigationManager.NavigateTo("/login");
    }

}
